<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WW1 Air Patrol</title>
<style>
  body { margin: 0; background: #87CEEB; overflow: hidden; font-family: Segoe UI, Tahoma; }
  canvas { display: block; margin: 0 auto; background: #87CEEB; }
</style>
</head>
<body>
<canvas id="gameCanvas" width="900" height="600"></canvas>
<script>

// === CONFIG ===
const API_URL = "https://script.google.com/macros/s/AKfycbx2LX4H44GGE-wUsTZeR-ldi9p6xyk_AX4MaH2gbOLIZZGHtJlj7ncejmA85VrPqkqg1Q/exec";
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const W = canvas.width;
const H = canvas.height;
const GROUND_HEIGHT = 90;
const UI_FONT = "20px Segoe UI";

// === IMAGES ===
const planeImg = new Image();
planeImg.src = "images/FokkerDR3.png";

const landscapeImg = new Image();
landscapeImg.src = "images/landscape.png";

const obsBaloonImg = new Image();
obsBaloonImg.src = "images/ObsBaloon.png";

const zeppelinImg = new Image();
zeppelinImg.src = "images/Zeppelin.png";

// === GAME STATE ===
let screen = "splash";
let pilotName = "";
let nameInputActive = true;

let planeX = 120;
let planeY = 260;
let planeVY = 0;
let gravity = 0.45;
let flapStrength = -8;
let score = 0;
let bestLocalScore = 0;
let obstacles = [];
let gameRunning = false;
let sentOnline = false;

// === LOAD LOCAL BEST ===
bestLocalScore = Number(localStorage.getItem("bestScore") || 0);

// === OBSTACLE CREATION ===
function createObstacle() {
  const gap = 180;
  const topHeight = Math.random() * (H - GROUND_HEIGHT - gap - 100) + 50;
  const bottomY = topHeight + gap;
  const speed = 3;

  obstacles.push({
    x: W + 50,
    topHeight,
    bottomY,
    width: 80,
    speed,
    sprite: Math.random() < 0.5 ? obsBaloonImg : zeppelinImg
  });
}

// === RESET ===
function resetGame() {
  planeY = 260;
  planeVY = 0;
  obstacles = [];
  score = 0;
  sentOnline = false;
  gameRunning = false;
}

// === FLAP ===
function flap() {
  planeVY = flapStrength;
}

// === UPDATE ===
function updateGame() {
  planeVY += gravity;
  planeY += planeVY;

  obstacles.forEach((o) => {
    o.x -= o.speed;
  });

  if (obstacles.length > 0 && obstacles[0].x < -120) {
    obstacles.shift();
  }

  if (Math.random() < 0.015) createObstacle();

  obstacles.forEach((o) => {
    if (planeX + 60 > o.x && planeX < o.x + o.width) {
      if (planeY < o.topHeight || planeY + 40 > o.bottomY) {
        screen = "gameover";
      }
    }
  });

  if (planeY + 40 > H - GROUND_HEIGHT) {
    screen = "gameover";
  }

  if (screen === "game") score++;
}

// === DRAW ===
function drawGame() {
  ctx.clearRect(0, 0, W, H);

  ctx.drawImage(landscapeImg, 0, H - GROUND_HEIGHT, W, GROUND_HEIGHT);

  obstacles.forEach((o) => {
    ctx.drawImage(o.sprite, o.x, o.topHeight - 60, o.width, 60);
    ctx.drawImage(o.sprite, o.x, o.bottomY, o.width, 60);
  });

  ctx.drawImage(planeImg, planeX - 30, planeY - 20, 60, 40);

  ctx.fillStyle = "#fff";
  ctx.font = UI_FONT;
  ctx.fillText(`Score: ${score}`, 20, 40);
  ctx.fillText(`Best: ${bestLocalScore}`, 20, 70);
}

// === SPLASH ===
function drawSplash() {
  ctx.clearRect(0, 0, W, H);
  ctx.fillStyle = "#fff";
  ctx.font = "32px Segoe UI";
  ctx.fillText("WW1 AIR PATROL", W/2 - 140, 120);

  ctx.font = "22px Segoe UI";
  ctx.fillText("Enter Pilot Name:", W/2 - 110, 200);
  ctx.fillText(pilotName || "_", W/2 - 20, 240);
  ctx.font = "18px Segoe UI";
  ctx.fillText("PRESS TAP OR SPACE TO START", W/2 - 150, 320);
}

// === GAME OVER ===
function drawGameOver() {
  ctx.clearRect(0, 0, W, H);

  ctx.fillStyle = "#fff";
  ctx.font = "36px Segoe UI";
  ctx.fillText("GAME OVER", W/2 - 110, 140);

  ctx.font = "26px Segoe UI";
  ctx.fillText(`Score: ${score}`, W/2 - 60, 200);
  ctx.fillText(`Best: ${bestLocalScore}`, W/2 - 60, 240);

  ctx.font = "18px Segoe UI";
  ctx.fillText("TAP OR SPACE TO RESTART", W/2 - 130, 320);
}

// === ONLINE SCORE ===
function sendScoreOnline(name, newScore) {
  try {
    fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      headers: {
        "Content-Type": "text/plain;charset=utf-8"
      },
      body: JSON.stringify({ name: name, score: newScore })
    });
  } catch (err) {
    console.log("Online score send failed:", err);
  }
}

// === MAIN LOOP ===
function gameLoop() {
  if (screen === "game") updateGame();
  if (screen === "game") drawGame();
  if (screen === "splash") drawSplash();
  if (screen === "gameover") drawGameOver();
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

// === INPUT ===
function handleInput() {
  if (screen === "splash") {
    if (pilotName.length > 0) {
      screen = "game";
      resetGame();
      gameRunning = true;
      return;
    }
  }

  if (screen === "game") flap();

  if (screen === "gameover") {
    if (score > bestLocalScore) {
      bestLocalScore = score;
      localStorage.setItem("bestScore", bestLocalScore);
    }

    if (!sentOnline && score > 0) {
      sendScoreOnline(pilotName, score);
      sentOnline = true;
    }

    resetGame();
    screen = "game";
  }
}

// Keyboard
window.addEventListener("keydown", (e) => {
  if (screen === "splash") {
    if (e.key.length === 1 && pilotName.length < 12) {
      pilotName += e.key;
    }
    if (e.key === "Backspace") pilotName = pilotName.slice(0, -1);
  }

  if (e.code === "Space" || e.code === "ArrowUp") handleInput();
});

// Mouse / Touch
canvas.addEventListener("mousedown", handleInput);
canvas.addEventListener("touchstart", handleInput);

</script>
</body>
</html>
