<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WW1 Air Patrol</title>
<style>
  body {
    margin: 0;
    background: #87CEEB;
    overflow: hidden;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: #87CEEB;
  }
</style>
</head>
<body>
<canvas id="gameCanvas" width="900" height="600"></canvas>
<script>
// === CONFIG ===
const API_URL = "https://script.google.com/macros/s/AKfycbx2LX4H44GGE-wUsTZeR-ldi9p6xyk_AX4MaH2gbOLIZZGHtJlj7ncejmA85VrPqkqg1Q/exec";

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const W = canvas.width;
const H = canvas.height;
const GROUND_HEIGHT = 90;
const UI_FONT = "20px Segoe UI";

// === IMAGES ===
// Use root paths – your PNGs are in repo root
const planeImg = new Image();
planeImg.src = "FokkerDR3.png";

const obsBaloonImg = new Image();
obsBaloonImg.src = "ObsBaloon.png";

const zeppelinImg = new Image();
zeppelinImg.src = "Zeppelin.png";

// === GAME STATE ===
let screen = "splash";      // "splash" | "game" | "gameover"
let pilotName = "";
let planeX = 120;
let planeY = 260;
let planeVY = 0;
let gravity = 0.45;
let flapStrength = -8;
let score = 0;
let bestLocalScore = 0;
let obstacles = [];
let sentOnline = false;

// === LOAD LOCAL BEST ===
bestLocalScore = Number(localStorage.getItem("bestScore") || 0);

// === OBSTACLE CREATION ===
function createObstacle() {
  const gap = 180;
  const topHeight = Math.random() * (H - GROUND_HEIGHT - gap - 100) + 50;
  const bottomY = topHeight + gap;
  const speed = 3;

  obstacles.push({
    x: W + 50,
    topHeight,
    bottomY,
    width: 80,
    speed,
    sprite: Math.random() < 0.5 ? obsBaloonImg : zeppelinImg,
    passed: false
  });
}

// === RESET ===
function resetGame() {
  planeY = 260;
  planeVY = 0;
  obstacles = [];
  score = 0;
  sentOnline = false;
}

// === FLAP ===
function flap() {
  planeVY = flapStrength;
}

// === UPDATE ===
function updateGame() {
  // physics
  planeVY += gravity;
  planeY += planeVY;

  // move obstacles
  obstacles.forEach(o => {
    o.x -= o.speed;
  });

  // remove off-screen obstacles
  if (obstacles.length > 0 && obstacles[0].x < -120) {
    obstacles.shift();
  }

  // spawn new obstacles
  if (Math.random() < 0.015) createObstacle();

  // collisions + scoring
  obstacles.forEach(o => {
    const planeW = 60;
    const planeH = 40;

    // collision horizontally in obstacle span
    if (planeX + planeW > o.x && planeX < o.x + o.width) {
      // check if inside gap -> if not, hit
      if (planeY < o.topHeight || planeY + planeH > o.bottomY) {
        screen = "gameover";
      }
    }

    // score when plane passes mid of obstacle
    if (!o.passed && planeX > o.x + o.width) {
      o.passed = true;
      score += 1;
    }
  });

  // ground hit
  if (planeY + 40 > H - GROUND_HEIGHT) {
    screen = "gameover";
  }

  // top boundary
  if (planeY < 0) {
    planeY = 0;
    planeVY = 0;
  }
}

// === DRAW BACKGROUND ===
function drawBackground() {
  // sky
  ctx.fillStyle = "#87CEEB";
  ctx.fillRect(0, 0, W, H);

  // ground
  const groundY = H - GROUND_HEIGHT;
  const grad = ctx.createLinearGradient(0, groundY, 0, H);
  grad.addColorStop(0, "#5d8b3b");
  grad.addColorStop(1, "#3a5b23");
  ctx.fillStyle = grad;
  ctx.fillRect(0, groundY, W, GROUND_HEIGHT);
}

// === DRAW GAME ===
function drawGame() {
  drawBackground();

  // obstacles
  obstacles.forEach(o => {
    const imgTop = o.sprite && o.sprite.complete ? o.sprite : null;
    const imgBottom = imgTop;

    // top
    if (imgTop) {
      ctx.drawImage(imgTop, o.x, o.topHeight - 60, o.width, 60);
    } else {
      ctx.fillStyle = "#c9c9c9";
      ctx.fillRect(o.x, 0, o.width, o.topHeight);
    }

    // bottom
    if (imgBottom) {
      ctx.drawImage(imgBottom, o.x, o.bottomY, o.width, 60);
    } else {
      ctx.fillStyle = "#c9c9c9";
      ctx.fillRect(o.x, o.bottomY, o.width, H - GROUND_HEIGHT - o.bottomY);
    }
  });

  // plane
  if (planeImg.complete) {
    ctx.drawImage(planeImg, planeX - 30, planeY - 20, 60, 40);
  } else {
    ctx.fillStyle = "#ff0000";
    ctx.fillRect(planeX - 30, planeY - 20, 60, 40);
  }

  // HUD
  ctx.fillStyle = "#ffffff";
  ctx.font = UI_FONT;
  ctx.fillText(`Pilot: ${pilotName || "-"}`, 20, 30);
  ctx.fillText(`Score: ${score}`, 20, 60);
  ctx.fillText(`Best: ${bestLocalScore}`, 20, 90);
}

// === SPLASH ===
function drawSplash() {
  drawBackground();

  ctx.fillStyle = "#ffffff";
  ctx.textAlign = "center";

  ctx.font = "40px Segoe UI";
  ctx.fillText("WW1 AIR PATROL", W / 2, 150);

  ctx.font = "24px Segoe UI";
  ctx.fillText("Enter Pilot Name (SPACE/TAP):", W / 2, 230);

  ctx.font = "22px Segoe UI";
  ctx.fillText(pilotName || "_", W / 2, 270);

  ctx.font = "18px Segoe UI";
  ctx.fillText("Press SPACE or TAP to start", W / 2, 340);
}

// === GAME OVER ===
function drawGameOver() {
  drawBackground();

  ctx.fillStyle = "#ffffff";
  ctx.textAlign = "center";

  ctx.font = "40px Segoe UI";
  ctx.fillText("GAME OVER", W / 2, 160);

  ctx.font = "26px Segoe UI";
  ctx.fillText(`Pilot: ${pilotName || "-"}`, W / 2, 210);
  ctx.fillText(`Score: ${score}`, W / 2, 250);
  ctx.fillText(`Best: ${bestLocalScore}`, W / 2, 290);

  ctx.font = "18px Segoe UI";
  ctx.fillText("Press SPACE or TAP to try again", W / 2, 340);
}

// === ONLINE SCORE ===
function sendScoreOnline(name, newScore) {
  if (!name || !newScore || newScore <= 0) return;
  try {
    fetch(API_URL, {
      method: "POST",
      mode: "no-cors", // avoid CORS preflight
      headers: {
        "Content-Type": "text/plain;charset=utf-8"
      },
      body: JSON.stringify({ name, score: newScore })
    });
  } catch (err) {
    console.log("Online score send failed:", err);
  }
}

// === MAIN LOOP ===
function gameLoop() {
  if (screen === "game") {
    updateGame();
    drawGame();
  } else if (screen === "splash") {
    drawSplash();
  } else if (screen === "gameover") {
    drawGameOver();
  }

  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

// === INPUT HANDLER ===
function handleInput() {
  if (screen === "splash") {
    // if no name yet, ask via prompt (better for iPhone)
    if (!pilotName) {
      const name = prompt("Enter pilot name:", "");
      if (name && name.trim()) {
        pilotName = name.trim();
      } else {
        pilotName = "Unknown";
      }
      // start game immediately after entering name
      resetGame();
      flap();
      screen = "game";
      return;
    } else {
      // already have a name → just start
      resetGame();
      flap();
      screen = "game";
      return;
    }
  }

  if (screen === "game") {
    flap();
    return;
  }

  if (screen === "gameover") {
    // update local best
    if (score > bestLocalScore) {
      bestLocalScore = score;
      localStorage.setItem("bestScore", bestLocalScore);
    }

    // send score online once per game
    if (!sentOnline && score > 0) {
      sendScoreOnline(pilotName, score);
      sentOnline = true;
    }

    resetGame();
    flap();
    screen = "game";
    return;
  }
}

// === KEYBOARD INPUT ===
window.addEventListener("keydown", (e) => {
  if (screen === "splash") {
    // allow typing name directly from keyboard
    if (e.key.length === 1 && pilotName.length < 12) {
      pilotName += e.key;
    }
    if (e.key === "Backspace") {
      e.preventDefault();
      pilotName = pilotName.slice(0, -1);
    }
  }

  if (e.code === "Space" || e.code === "ArrowUp") {
    e.preventDefault();
    handleInput();
  }
});

// === MOUSE / TOUCH INPUT ===
canvas.addEventListener("mousedown", (e) => {
  e.preventDefault();
  handleInput();
});
canvas.addEventListener("touchstart", (e) => {
  e.preventDefault();
  handleInput();
}, { passive: false });

</script>
</body>
</html>
